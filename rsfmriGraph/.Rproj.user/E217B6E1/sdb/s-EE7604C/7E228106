{
    "contents" : "Resting state analysis for anoxia data set\n========================================================\nBrian Caffo\n-------------------------\n```{r, echo = TRUE}\ndate()\n```\n\nThis is a resting staet analysis for the anoxia data set of Robert Stevens\n\n\n```{r, echo = FALSE}\nsetwd(\"~/Google Drive/Work/Research/Investigators/robert stevens\")\ndataDir <- \"D:/Robert_Stevens_Anoxia/Timecourses\" \nsubjects <- dir(dataDir)\nclinicalData <- read.csv(\"D:/Robert_Stevens_Anoxia/Clinical_data/Anoxia-List-For_analysis_04022014.csv\",stringsAsFactors = FALSE)\n#clinicalData <- clinicalData[, 1: 8]\ncolnames(clinicalData) <- c(\"id\", \"sex\", \"age\", \"delay\", \"cpc\", \"gos\", \"outcome\", \"sedation\", \"location\")\nAsubjects <- subjects[grep(\"A\", subjects)]\nNsubjects <- subjects[grep(\"N\", subjects)]\nclinicalData <- merge(clinicalData, data.frame(id = Nsubjects), by = \"id\", all = TRUE)\nclinicalData$anoxia <- 0\nclinicalData$anoxia[grep(\"A\", clinicalData$id)] <- 1\nsubjectsWithClinical <- subjects[subjects %in% clinicalData$id]\nclinicalData$sedation[clinicalData$sedation == \"\"] <- NA\nclinicalData$sedation2 <- NA\nclinicalData$sedation2[grep(\"Yes\", clinicalData$sedation, ignore.case = TRUE)] <- 1\nclinicalData$sedation2[clinicalData$sedation == \"No\" | clinicalData$sedation == \"no\"] <- 0\n\nroi36 <- read.csv(\"d:/Robert_Stevens_Anoxia/Seed_Coorindates_forBrian36.csv\")[ , 1 : 4]\nnames(roi36) <- c(\"network\", \"name\", \"short\", \"mni\")\n\n```\n\n## Some basics\n* There are `r length(subjects)` in the data directory.\n* All subjects have clinical data? `r all(subjects %in% clinicalData$id)` (Note it's the N subjects)\n* Subjects labeled A without clinical data `r Asubjects[!(Asubjects %in% clinicalData$id)]`\n\n```{r, echo = TRUE}\nsummary(clinicalData$age)\ntable(clinicalData$sex)\nsummary(clinicalData$delay)\ntable(clinicalData$outcome)\ntable(clinicalData$sedation, useNA = 'always')\ntable(clinicalData$sedation, clinicalData$sedation2, useNA = 'always')\ntable(clinicalData$cpc)\ntable(clinicalData$gos)\ntable(clinicalData$location)\ntable(clinicalData$sedation2, clinicalData$outcome)\ntable(clinicalData$cpc, clinicalData$outcome)\ntable(clinicalData$gos, clinicalData$outcome)\ntable(clinicalData$location, clinicalData$outcome)\n```\n\nAge distribution correlated with outcome?\n```{r}\nsummary(lm(age ~ factor(outcome), data = clinicalData, subset = anoxia == 1))\nsummary(glm(I(sex == \"M\") ~ factor(outcome), data = clinicalData, subset = anoxia == 1, family = binomial))\nfisher.test(table(clinicalData$sedation2, clinicalData$outcome))\n#summary(glm(sedation2 ~ factor(outcome), data = clinicalData, subset = anoxia == 1, family = binomial))\nsummary(lm(I(log(delay)) ~ factor(outcome), data = clinicalData))\nfisher.test(table(clinicalData$cpc, clinicalData$outcome))\nfisher.test(table(clinicalData$gos, clinicalData$outcome))\nfisher.test(table(clinicalData$location, clinicalData$outcome))\n```\n\n\n## Looking at the roidata\nLoad \n```{r, echo=TRUE}\nlibrary(oro.nifti); library(R.matlab)\nfname <- paste(dataDir, \"/\", subjects[1], \"/tc_sfnfwrs4dm10.nii_ROI_36_6mm_merged.nii.mat\",  sep = \"\")\ntempDat <- readMat(fname)\nnames(tempDat)\n```\n\nSubjects without ROI values\n```{r, echo = FALSE, results='hide'}\nfnames <- paste(dataDir, \"/\", subjectsWithClinical, \"/tc_sfnfwrs4dm10.nii_ROI_36_6mm_merged.nii.mat\",  sep = \"\")\ntestfname <- file.exists(fnames)\n```\nThe subjects `r subjectsWithClinical[!testfname]` have no ROI imaging data\n\nThis only applies to subjects with matching clinical data.\nRead in the data\n```{r, echo = TRUE, results = 'hide'}\nout <- lapply(subjectsWithClinical[testfname], \n              function(subject){\nfname <- paste(dataDir, \"/\", subject, \"/tc_sfnfwrs4dm10.nii_ROI_36_6mm_merged.nii.mat\",  sep = \"\")\ntempDat <- readMat(fname)\nprint(subject)\nreturn(tempDat)   \n                  }\n              )\n```\nCheck the dimension across subjects. Check the number of ROIs.\n\n```{r, echo = TRUE}\ndimension <- sapply(out, function(x) dim(x$roi.tc.eig))\ntable(dimension[1,])\ntable(dimension[2,])\nsize <- sapply(out, function(x) table(x$size.roi))\nsize\n```\n\nCheck to see if scan length is associated with dx.\n```{r}\ndimDat <- data.frame(id = subjectsWithClinical[testfname], scanlength = dimension[2,])\nclinicalData <- merge(dimDat, clinicalData, by = \"id\")\ntable(clinicalData$outcome, clinicalData$scanlength)\nfisher.test(table(clinicalData$scanlength, clinicalData$outcome))\n```\n\n\n```{r, echo = TRUE}\n##get the correlation vectors\ncor2vec <- function(sigma) sigma[upper.tri(sigma, diag = FALSE)]\n## note that the 37th one is the extraneous one\n## There's also one person who has some messed up data\nnames(out) <- subjectsWithClinical[testfname]\n## REMEMBER TO CHANGE THIS IF ANYTHING CHANGES WITH THE DATA NAMES\nout <- out[-67]\ncors <- t(sapply(out, function(x) cor2vec(cor(t(x$roi.tc.eig[-37,])))))\ncorDat <- data.frame(id = names(out), cors)\nclinicalData <- merge(clinicalData, corDat, by = \"id\")\nxs <- clinicalData[, grep(\"X\", names(clinicalData))]\ny <- clinicalData$anoxia\npv <- apply(xs, 2,  function(x) t.test(x ~ y)$p.value)\nhist(pv)\nplot(density(pv))\ntable(pv < .05 / length(pv))\nvec2cor <- function(vec, n){ rval <- diag(rep(1, n)); rval[upper.tri(rval)] <- vec; return(rval + t(rval) - diag(rep(1, n)))} \n\n\nbreaks <- c(-1, .01 / length(pv),  .05 / length(pv), .1 / length(pv), 1)\ncol <- colors()[c(555, 641, 30, 205)]\nimage(1 : 36, 1 : 36, vec2cor(pv, 36), \n     breaks = breaks, col = col, axes = FALSE, xlab = \"\", ylab = \"\")\ngroups <- c(5, 10, 18, 23, 30, 33, 35) - .5\nabline(v = groups, col = \"white\", lwd = 3)\nabline(h = groups, col = \"white\", lwd = 3)\nabline(v = seq(.5, 35.5, by = 1), col = \"white\", lwd = 1)\nabline(h = seq(.5, 35.5, by = 1), col = \"white\", lwd = 1)\nat <- c(0, groups) + (c(groups, 36) - c(0, groups)) / 2\nlabels <- c(\"DMN1\", \"DMN2\", \"DA\", \"EC\", \"Sal\", \"SM\", \"Vis\", \"Aud\")\nfor (i in 1 : 4) mtext(side = i, at = at, text = labels)\n\n\ncols <- cor2vec(matrix(rep(1 : 36, 36), 36, byrow = TRUE))\nrows <- cor2vec(matrix(rep(1 : 36, 36), 36, byrow = FALSE))\ntemp <- order(pv)\npar(mfrow = c(3, 3))\nfor (i in 1 : 9) {\n    boxplot(cors[, temp[i]] ~ y)\n    title(paste(roi36$short[rows[temp[i]]], roi36$short[cols[temp[i]]]))\n}\n\nimage(1 : 36, 1 : 36, vec2cor(rank(pv), 36), \n     breaks = breaks, col = col, axes = FALSE, xlab = \"\", ylab = \"\")\n```\n\n\n```{r}\ny2 <- clinicalData$outcome\npv2 <- apply(xs, 2,  function(x) t.test(x ~ y2)$p.value)\nsum(pv2 < .05 / length(pv2))\n\nbreaks <- c(-1, alpha / length(pv), alpha / 10, alpha, 1)\ncol <- colors()[c(555, 641, 30, 205)]\nimage(1 : 36, 1 : 36, vec2cor(pv2, 36), \n     breaks = breaks, col = col, axes = FALSE, xlab = \"\", ylab = \"\")\ngroups <- c(5, 10, 18, 23, 30, 33, 35) - .5\nabline(v = groups, col = \"white\", lwd = 3)\nabline(h = groups, col = \"white\", lwd = 3)\nabline(v = seq(.5, 35.5, by = 1), col = \"white\", lwd = 1)\nabline(h = seq(.5, 35.5, by = 1), col = \"white\", lwd = 1)\nat <- c(0, groups) + (c(groups, 36) - c(0, groups)) / 2\nlabels <- c(\"DMN1\", \"DMN2\", \"DA\", \"EC\", \"Sal\", \"SM\", \"Vis\", \"Aud\")\nfor (i in 1 : 4) mtext(side = i, at = at, text = labels)\n\ncols <- cor2vec(matrix(rep(1 : 36, 36), 36, byrow = TRUE))\nrows <- cor2vec(matrix(rep(1 : 36, 36), 36, byrow = FALSE))\ntemp <- order(pv2)\npar(mfrow = c(3, 3))\nfor (i in 1 : 9) {\n    boxplot(cors[ , temp[i]] ~ y2)\n    title(paste(rows[temp[i]], cols[temp[i]]))\n}\n\n```\n\n\n\n",
    "created" : 1398884244450.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2163779509",
    "id" : "7E228106",
    "lastKnownWriteTime" : 1397660633,
    "path" : "C:/Users/Brian/Google Drive/Work/Research/Investigators/robert stevens/restingAnalysis3.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "source_on_save" : false,
    "type" : "r_markdown"
}